{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}‡¥Ü‡µº‡¥ï‡µç‡¥ï‡µà‡¥µ‡µç ‚Äî ‡¥é‡¥≤‡µç‡¥≤‡¥æ ‡¥≤‡¥ï‡µç‡¥ï‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥Ç ‚Äî ‡¥á‡¥®‡µç‡¥§‡µç‡¥Ø‡µª ‡¥§‡µä‡¥¥‡¥ø‡¥≤‡¥æ‡¥≥‡¥ø{% endblock %}

{% block body_class %}{% endblock %}

{% block extra_css %}
<style>
    /* ===== PAGE ===== */
    .archive-page {
        padding: var(--space-section) 0;
        min-height: 100vh;
    }

    .archive-page__wrapper {
        max-width: var(--max-width);
        margin: 0 auto;
        padding: 0 var(--gutter);
    }

    /* ===== HEADER ===== */
    .archive-page__header {
        text-align: center;
        margin-bottom: clamp(40px, 6vh, 56px);
        padding-top: 80px;
    }

    .archive-page__title {
        font-family: var(--font-serif);
        font-size: clamp(40px, 7vw, 72px);
        font-weight: 700;
        line-height: 1.1;
        letter-spacing: -0.025em;
        margin-bottom: 16px;
        color: var(--ink);
    }

    .archive-page__description {
        font-size: clamp(16px, 2vw, 18px);
        color: var(--ink-muted);
        max-width: 600px;
        margin: 0 auto 24px;
    }

    /* ===== STATS ===== */
    .archive-stats {
        display: inline-flex;
        align-items: center;
        gap: 24px;
        margin-top: 24px;
        padding: 16px 24px;
        background: var(--bg-alt);
        border-radius: 24px;
    }

    .archive-stat {
        display: flex;
        align-items: center;
        gap: 8px;
        font-family: var(--font-ui);
        font-size: 13px;
        color: var(--ink-secondary);
    }

    .archive-stat__number {
        font-weight: 700;
        color: var(--ink);
    }

    /* ===== YEAR SECTION ===== */
    .year-section {
        margin-bottom: clamp(72px, 10vh, 96px);
    }

    .year-section__header {
        display: flex;
        align-items: center;
        gap: 24px;
        margin-bottom: clamp(32px, 5vh, 48px);
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border);
    }

    .year-section__title {
        font-family: var(--font-serif);
        font-size: clamp(32px, 5vw, 48px);
        font-weight: 700;
        color: var(--ink);
        margin: 0;
        letter-spacing: -0.02em;
    }

    .year-section__count {
        font-family: var(--font-ui);
        font-size: 14px;
        font-weight: 600;
        color: var(--ink-muted);
        padding: 6px 16px;
        background: var(--bg-alt);
        border-radius: 20px;
    }

    /* ===== GRID ===== */
    .year-section__grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: clamp(24px, 3vw, 36px);
    }

    @media (min-width: 1280px) {
        .year-section__grid {
            grid-template-columns: repeat(5, 1fr);
        }
    }

    @media (max-width: 1024px) {
        .year-section__grid {
            grid-template-columns: repeat(4, 1fr);
        }
    }

    @media (max-width: 768px) {
        .year-section__grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
    }

    @media (max-width: 640px) {
        .year-section__grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }
    }

    /* ===== ARCHIVE ITEM ===== */
    .archive-item {
        transition: transform 0.5s var(--ease-out);
        animation: fadeInUp 0.6s var(--ease-out) both;
    }

    .archive-item>a {
        display: block;
        text-decoration: none;
        color: inherit;
    }

    .archive-item:nth-child(1) {
        animation-delay: 0.05s;
    }

    .archive-item:nth-child(2) {
        animation-delay: 0.10s;
    }

    .archive-item:nth-child(3) {
        animation-delay: 0.15s;
    }

    .archive-item:nth-child(4) {
        animation-delay: 0.20s;
    }

    .archive-item:nth-child(5) {
        animation-delay: 0.25s;
    }

    .archive-item:nth-child(6) {
        animation-delay: 0.30s;
    }

    .archive-item:nth-child(7) {
        animation-delay: 0.35s;
    }

    .archive-item:nth-child(8) {
        animation-delay: 0.40s;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .archive-item:hover {
        transform: translateY(-8px);
    }

    /* ===== COVER ===== */
    .archive-item__cover {
        position: relative;
        aspect-ratio: 5 / 7;
        overflow: hidden;
        border-radius: 1px;
        background: var(--bg-alt);
        margin-bottom: 12px;
        box-shadow: 0 2px 12px rgba(26, 24, 20, 0.08);
        transition: box-shadow 0.4s ease;
    }

    .archive-item:hover .archive-item__cover {
        box-shadow: 0 8px 24px rgba(26, 24, 20, 0.16);
    }

    .archive-item__cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.6s var(--ease-out);
    }

    .archive-item:hover .archive-item__cover img {
        transform: scale(1.08);
    }

    /* ===== OVERLAY ===== */
    .archive-item__overlay {
        position: absolute;
        inset: 0;
        background: linear-gradient(to top,
                rgba(26, 24, 20, 0.85) 0%,
                rgba(26, 24, 20, 0.3) 50%,
                transparent 100%);
        opacity: 0;
        transition: opacity 0.4s ease;
        display: flex;
        align-items: flex-end;
        justify-content: center;
        padding: 20px;
        z-index: 2;
    }

    .archive-item:hover .archive-item__overlay {
        opacity: 1;
    }

    /* ===== DOWNLOAD BUTTON ===== */
    .archive-item__download {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 48px;
        height: 48px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 50%;
        color: var(--ink);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25);
        transition: all 0.3s var(--ease-out);
    }

    .archive-item__download:hover {
        background: #fff;
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 6px 24px rgba(0, 0, 0, 0.35);
    }

    /* ===== BADGE ===== */
    .archive-item__badge {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 5px 10px;
        background: rgba(26, 24, 20, 0.85);
        backdrop-filter: blur(8px);
        color: #fff;
        font-family: var(--font-ui);
        font-size: 10px;
        font-weight: 600;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        border-radius: 4px;
        z-index: 1;
    }

    /* ===== INFO ===== */
    .archive-item__info {
        padding: 0 4px;
    }

    .archive-item__info h3 {
        font-family: var(--font-ui);
        font-size: 13px;
        font-weight: 600;
        color: var(--ink);
        margin: 0 0 4px;
        line-height: 1.4;
    }

    .archive-item__info p {
        font-family: var(--font-ui);
        font-size: 11px;
        color: var(--ink-muted);
        line-height: 1.4;
        margin: 0;
    }

    /* ===== PAGINATION ===== */
    .archive-pagination {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: clamp(48px, 7vh, 72px) 0;
        border-top: 1px solid var(--border);
        margin-top: clamp(24px, 4vh, 40px);
    }

    .archive-pagination__info {
        width: 100%;
        text-align: center;
        font-family: var(--font-ui);
        font-size: 12px;
        color: var(--ink-muted);
        margin-bottom: 16px;
        letter-spacing: 0.04em;
    }

    .archive-pagination__btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 44px;
        height: 44px;
        padding: 0 14px;
        font-family: var(--font-ui);
        font-size: 14px;
        font-weight: 600;
        background: transparent;
        color: var(--ink-secondary);
        border: 1px solid var(--border);
        border-radius: 8px;
        text-decoration: none;
        transition: all 0.25s var(--ease-out);
        cursor: pointer;
        line-height: 1;
        user-select: none;
    }

    .archive-pagination__btn:hover {
        background: var(--bg-alt);
        border-color: var(--ink);
        color: var(--ink);
        transform: translateY(-2px);
    }

    .archive-pagination__btn--active {
        background: var(--ink);
        color: var(--bg);
        border-color: var(--ink);
        pointer-events: none;
    }

    /* Override hover for active */
    .archive-pagination__btn--active:hover {
        background: var(--ink);
        color: var(--bg);
        transform: none;
    }

    .archive-pagination__btn--disabled {
        opacity: 0.25;
        cursor: not-allowed;
        pointer-events: none;
    }

    .archive-pagination__ellipsis {
        padding: 0 6px;
        font-family: var(--font-ui);
        font-size: 16px;
        color: var(--ink-muted);
        user-select: none;
        line-height: 44px;
    }

    /* ===== EMPTY STATE ===== */
    .archive-page__empty {
        text-align: center;
        padding: 80px 20px;
    }

    .archive-page__empty-icon {
        font-size: 64px;
        margin-bottom: 24px;
        opacity: 0.3;
    }

    .archive-page__empty h2 {
        font-family: var(--font-serif);
        font-size: clamp(24px, 4vw, 32px);
        margin-bottom: 16px;
        color: var(--ink);
    }

    .archive-page__empty p {
        color: var(--ink-muted);
        font-family: var(--font-ui);
        font-size: 16px;
    }

    /* ===== BACK TO TOP ===== */
    .back-to-top {
        position: fixed;
        bottom: 40px;
        right: 40px;
        width: 52px;
        height: 52px;
        background: var(--ink);
        color: var(--bg);
        border: none;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        opacity: 0;
        pointer-events: none;
        transition: all 0.3s var(--ease-out);
        box-shadow: 0 4px 16px rgba(26, 24, 20, 0.2);
        z-index: 100;
    }

    .back-to-top.visible {
        opacity: 1;
        pointer-events: all;
    }

    .back-to-top:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(26, 24, 20, 0.3);
    }

    @media (max-width: 768px) {
        .back-to-top {
            bottom: 24px;
            right: 24px;
            width: 44px;
            height: 44px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="archive-page">
    <div class="archive-page__wrapper">

        <!-- ===== HEADER ===== -->
        <header class="archive-page__header">
            <h1 class="archive-page__title">‡¥∏‡¥Æ‡µç‡¥™‡µÇ‡µº‡¥£‡µç‡¥£ ‡¥Ü‡µº‡¥ï‡µç‡¥ï‡µà‡¥µ‡µç</h1>
            <p class="archive-page__description">
                ‡¥á‡¥®‡µç‡¥§‡µç‡¥Ø‡µª ‡¥§‡µä‡¥¥‡¥ø‡¥≤‡¥æ‡¥≥‡¥ø ‡¥Æ‡¥æ‡¥∏‡¥ø‡¥ï‡¥Ø‡µÅ‡¥ü‡µÜ ‡¥é‡¥≤‡µç‡¥≤‡¥æ ‡¥™‡µç‡¥∞‡¥∏‡¥ø‡¥¶‡µç‡¥ß‡µÄ‡¥ï‡¥∞‡¥ø‡¥ö‡µç‡¥ö ‡¥≤‡¥ï‡µç‡¥ï‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥Ç ‡¥¨‡µç‡¥∞‡µó‡¥∏‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï
            </p>
            {% if total_count %}
            <div class="archive-stats">
                <div class="archive-stat">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                    </svg>
                    <span class="archive-stat__number">{{ total_count }}</span>
                    <span>‡¥Æ‡µä‡¥§‡µç‡¥§‡¥Ç ‡¥≤‡¥ï‡µç‡¥ï‡¥ô‡µç‡¥ô‡µæ</span>
                </div>
                <div class="archive-stat">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    <span class="archive-stat__number">{{ total_years }}</span>
                    <span>‡¥µ‡µº‡¥∑‡¥ô‡µç‡¥ô‡µæ</span>
                </div>
            </div>
            {% endif %}
        </header>

        <!-- ===== MAIN CONTENT ===== -->
        {% if magazines_by_year %}

        <!-- Year Sections ‚Äî iterates list of (year, magazines) tuples -->
        {% for year, magazines in magazines_by_year %}
        <section class="year-section" id="year-{{ year }}">

            <div class="year-section__header">
                <h2 class="year-section__title">{{ year }}</h2>
                <span class="year-section__count">{{ magazines|length }} ‡¥≤‡¥ï‡µç‡¥ï‡¥ô‡µç‡¥ô‡µæ</span>
            </div>

            <div class="year-section__grid">
                {% for magazine in magazines %}
                <div class="archive-item">
                    <a href="{% url 'magazine_detail' magazine.slug %}">

                        <div class="archive-item__cover">
                            {% if magazine.cover_image %}
                            <img src="{{ magazine.cover_image.url }}" alt="{{ magazine.title }}" loading="lazy"
                                width="500" height="700">
                            {% else %}
                            <div
                                style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:var(--ink-muted);font-size:12px;font-family:var(--font-ui);">
                                No Image
                            </div>
                            {% endif %}

                            <!-- Download overlay -->
                            <div class="archive-item__overlay">
                                {% if magazine.pdf %}
                                <a href="{{ magazine.pdf.url }}" class="archive-item__download" title="‡¥°‡µó‡µ∫‡¥≤‡µã‡¥°‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï"
                                    onclick="event.stopPropagation(); event.preventDefault(); window.open(this.href, '_blank');"
                                    download>
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                </a>
                                {% endif %}
                            </div>

                            <!-- Month badge -->
                            {% if magazine.issued_at %}
                            <div class="archive-item__badge">{{ magazine.issued_at|date:"M" }}</div>
                            {% endif %}
                        </div>

                        <div class="archive-item__info">
                            <h3>
                                {% if magazine.issued_at %}
                                {{ magazine.issued_at|date:"F Y" }}
                                {% else %}
                                ‡¥Æ‡¥æ‡¥∏‡¥ø‡¥ï
                                {% endif %}
                            </h3>
                            <p>{{ magazine.title|truncatewords:3 }}</p>
                        </div>

                    </a>
                </div>
                {% endfor %}
            </div>

        </section>
        {% endfor %}

        <!-- ===== PAGINATION ===== -->
        {% if paginated_magazines.has_other_pages %}
        <nav class="archive-pagination" aria-label="‡¥Ü‡µº‡¥ï‡µç‡¥ï‡µà‡¥µ‡µç ‡¥™‡µá‡¥ú‡¥ø‡¥®‡µá‡¥∑‡µª">

            <p class="archive-pagination__info">
                ‡¥™‡µá‡¥ú‡µç {{ paginated_magazines.number }} / {{ paginated_magazines.paginator.num_pages }}
                &nbsp;¬∑&nbsp;
                {{ total_count }} ‡¥≤‡¥ï‡µç‡¥ï‡¥ô‡µç‡¥ô‡µæ
            </p>

            <!-- Prev -->
            {% if paginated_magazines.has_previous %}
            <a href="?page={{ paginated_magazines.previous_page_number }}" class="archive-pagination__btn"
                aria-label="‡¥Æ‡µÅ‡¥Æ‡µç‡¥™‡¥§‡µç‡¥§‡µÜ">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </a>
            {% else %}
            <span class="archive-pagination__btn archive-pagination__btn--disabled" aria-disabled="true">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </span>
            {% endif %}

            <!-- Page numbers ‚Äî built in view, None = ellipsis -->
            {% for num in page_range %}
            {% if num %}
            {% if num == paginated_magazines.number %}
            <span class="archive-pagination__btn archive-pagination__btn--active" aria-current="page">{{ num }}</span>
            {% else %}
            <a href="?page={{ num }}" class="archive-pagination__btn">{{ num }}</a>
            {% endif %}
            {% else %}
            <span class="archive-pagination__ellipsis" aria-hidden="true">‚Ä¶</span>
            {% endif %}
            {% endfor %}

            <!-- Next -->
            {% if paginated_magazines.has_next %}
            <a href="?page={{ paginated_magazines.next_page_number }}" class="archive-pagination__btn"
                aria-label="‡¥Ö‡¥ü‡µÅ‡¥§‡µç‡¥§‡¥§‡µç">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </a>
            {% else %}
            <span class="archive-pagination__btn archive-pagination__btn--disabled" aria-disabled="true">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </span>
            {% endif %}

        </nav>
        {% endif %}

        {% else %}
        <!-- ===== EMPTY STATE ===== -->
        <div class="archive-page__empty">
            <div class="archive-page__empty-icon">üìö</div>
            <h2>‡¥á‡¥§‡µÅ‡¥µ‡¥∞‡µÜ ‡¥Ü‡µº‡¥ï‡µç‡¥ï‡µà‡¥µ‡µÅ‡¥ï‡µæ ‡¥á‡¥≤‡µç‡¥≤</h2>
            <p>‡¥Æ‡¥æ‡¥∏‡¥ø‡¥ï‡¥ï‡µæ ‡¥™‡µç‡¥∞‡¥∏‡¥ø‡¥¶‡µç‡¥ß‡µÄ‡¥ï‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥Æ‡µç‡¥™‡µã‡µæ ‡¥Ü‡µº‡¥ï‡µç‡¥ï‡µà‡¥µ‡µç ‡¥™‡µÇ‡¥∞‡¥ø‡¥™‡µç‡¥™‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥Ç.</p>
            <div style="margin-top: 32px;">
                <a href="{% url 'index' %}" class="btn-primary">
                    <span class="btn-primary__text">‡¥π‡µã‡¥Ç ‡¥™‡µá‡¥ú‡¥ø‡¥≤‡µá‡¥ï‡µç‡¥ï‡µç ‡¥™‡µã‡¥ï‡µÅ‡¥ï</span>
                </a>
            </div>
        </div>
        {% endif %}

    </div>
</div>

<!-- ===== BACK TO TOP ===== -->
<button class="back-to-top" id="backToTop" aria-label="‡¥Æ‡µÅ‡¥ï‡¥≥‡¥ø‡¥≤‡µá‡¥ï‡µç‡¥ï‡µç">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <polyline points="18 15 12 9 6 15"></polyline>
    </svg>
</button>

<script>
    const backToTopBtn = document.getElementById('backToTop');
    window.addEventListener('scroll', () => {
        backToTopBtn.classList.toggle('visible', window.scrollY > 400);
    });
    backToTopBtn.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
</script>

{% endblock %}